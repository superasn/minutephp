<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Minutephp : Minute PHP: PHP + AngularJS framework (v.001 alpha)">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Minutephp</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/superasn/minutephp">View on GitHub</a>

          <h1 id="project_title">Minutephp</h1>
          <h2 id="project_tagline">Minute PHP: PHP + AngularJS framework (v.001 alpha)</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/superasn/minutephp/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/superasn/minutephp/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a id="minutephp-php--angularjs-framework-v001" class="anchor" href="#minutephp-php--angularjs-framework-v001" aria-hidden="true"><span class="octicon octicon-link"></span></a>MinutePHP: PHP + AngularJS framework (<em>v.001</em>)</h2>

<h3>
<a id="frameworks-usp" class="anchor" href="#frameworks-usp" aria-hidden="true"><span class="octicon octicon-link"></span></a>Framework's USP:</h3>

<ul>
<li>Built-in support for AngularJS</li>
<li>Router can automatically inject <code>Model</code> objects into controller (which can be accessed via AngularJS too)</li>
<li>CRUD operations can be done with one single line of code in both PHP and AngularJS</li>
</ul>

<h3>
<a id="project-status" class="anchor" href="#project-status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Project status</h3>

<p>It's highly experimental code! I just want to share the concept (and code) to see <strong>if anyone interested in collaborating</strong> :)</p>

<h3>
<a id="demo-facebook-like-newsfeed" class="anchor" href="#demo-facebook-like-newsfeed" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Demo: Facebook like newsfeed</strong>
</h3>

<p><strong>Demo:</strong> Create a facebook like newsfeed in 2 minutes (using minimum code).</p>

<p><strong>Database setup:</strong> Our MySQL database contains a <code>user</code> table (<code>PK: user_id</code>), <code>posts</code> table (<code>PK: post_id</code>) and <code>comments</code> table (<code>PK: comment_id</code>). </p>

<p>The <code>posts</code> table references the <code>users</code> table (since the users make posts) and <code>comments</code> table references both <code>users</code> and <code>posts</code> table (because comments are made on posts by users).</p>

<p><strong>Understanding the <em>new</em> Router syntax:</strong></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-v"><span class="pl-pdv">$</span>r</span><span class="pl-ko">-&gt;</span>get(<span class="pl-v"><span class="pl-pdv">$</span>url</span>, <span class="pl-v"><span class="pl-pdv">$</span>controller</span>, <span class="pl-v"><span class="pl-pdv">$</span>acl</span>, â€¦<span class="pl-v"><span class="pl-pdv">$</span>models</span>)</span></pre></div>

<p>The first three arguments are pretty standard:</p>

<ol>
<li>
<p><em>$url:</em> URL <em>regex</em> to match address bar. Can contain placeholders (or regex). Placeholder format is ":name"
-1. Examples:</p>

<ol>
<li>/newsfeed/:user_id/</li>
<li>/newsfeed/:user_id(/:page)? <em>[here page parameter is optional]</em>
</li>
</ol>
</li>
<li>
<p><em>$controller:</em> format is similar to Laravel like "Filename@function"</p>

<ul>
<li>Examples:

<ol>
<li>Backend/Newsfeed@index <em>[This will invoke the <code>index</code> function in <code>Backend/Newsfeed</code> class]</em>
</li>
</ol>
</li>
</ul>
</li>
<li>
<p><em>$acl:</em> can be "true" for logged in otherwise false. </p>

<ul>
<li>Also supports strings like 'admin', 'power', 'business', 'trial', 'etc' (as defined in config file)</li>
</ul>
</li>
<li>
<p><strong>...$model objects: This is the unique part.</strong></p>

<ol>
<li>What are model objects?

<ol>
<li>Models are basically PHP objects that support CRUD operations (in both PHP and AngularJS). Something similar to an ORM but not that (as explained later).</li>
<li>The model classes are <em>automatically</em> generated by a script. So for our sample database MinutePHP has generated 5 PHP Model classes called <em>Users, Posts, Comments, PostsLikes and CommentsLikes</em>
</li>
<li>You can specify the Read, Update, Insert, and Delete permission for each model as "same_user", "any_user", "all", "none", "admin", etc (more later).</li>
</ol>
</li>
</ol>
</li>
<li><p><strong>The Router automatically injects these Model objects when invoking the Controller</strong></p></li>
</ol>

<p><strong>Here is some sample code:</strong></p>

<p><strong>File: <code>index.php</code></strong></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-c"><span class="pl-pdc">//</span>$r is instance of Router</span></span>
<span class="pl-s2"><span class="pl-c"><span class="pl-pdc">//</span>Sample matching routes are /newsfeed/1, /newsfeed/2, .. (last part =&gt; :user_id)</span></span>
<span class="pl-s2"><span class="pl-v"><span class="pl-pdv">$</span>r</span><span class="pl-ko">-&gt;</span>get(<span class="pl-s1"><span class="pl-pds">'</span>/newsfeed/:user_id<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>Backend/Newsfeed@index<span class="pl-pds">'</span></span>, <span class="pl-c1">true</span>, <span class="pl-s1"><span class="pl-pds">'</span>posts[user_id][]<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>users[posts.user_id] as poster<span class="pl-pds">'</span></span>)</span></pre></div>

<p>Explanation of the <em>last two parameters</em>:</p>

<ol>
<li>
<p><strong><em>posts[user_id][]</em></strong> - will find all rows in <code>posts</code> table with <code>user_id</code> = <code>:user_id</code> (the placeholder in URL). What this means to you is:</p>

<ol>
<li> It will then create <code>$posts</code> object (instance of Posts model) with an array of matching rows loaded from our <code>posts</code> table where <code>user_id=1</code> (if URL is <em>/newsfeed/1</em>).</li>
<li> It will pass the <code>$posts</code> object when invoking the controller (shown below). </li>
<li>It will <strong>create an AngularJS object</strong> for <code>$posts</code>, <strong>accessible as <code>$scope.posts</code> inside the view</strong>.</li>
<li>The <strong>[ ]</strong> at end is to specify we want <em>all</em> matching results (i.e. an array).</li>
<li><p>By default all models have a read permission of <em>same_user</em>, so /newsfeed/2 will return <em>permission denied error</em> (if the logged in user's <code>user_id</code> is <strong>1</strong> and you try to access /newsfeed/<strong>2</strong>).</p></li>
</ol>

<ul>
<li>Example: /newsfeed/<strong>1</strong> will create a <code>$posts</code> object and fill it with rows where user_id=<strong>1</strong>.</li>
</ul>
</li>
<li>
<p><strong><em>users[posts.user_id] as poster</em></strong> - this will create a join on <code>posts</code> and <code>users</code> table using <code>user_id</code>. As a result you will have:</p>

<ol>
<li>A <code>$poster</code> object (instance of User model) in your controller. </li>
<li>A reference to the <code>poster</code> inside each row of <code>$posts</code> object.</li>
<li>If it is getting confusing, think of it like an SQL query:
<code>SELECT * FROM posts as A, users as b where user_id = :user_id and b.user_id = a.user_id</code>
</li>
<li>It will also <strong>create an AngularJS object</strong> for you that you can <strong>access as <code>$scope.posts[0].poster</code>, <code>$scope.posts[1].poster.firstName</code></strong>, etc in your view.</li>
<li>Note that <strong>there is no [] at the end</strong> this time. It means that we want to load just our <strong>first matching row</strong> (returns single object not array. In JSON speak, it returns <code>{}</code> and not <code>[{}, {}, ...]</code>)</li>
</ol>
</li>
</ol>

<p><strong>Controller:</strong> <code>Backend/Newsfeed class</code></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-c"><span class="pl-pdc">//</span>This is the Controller class. It is invoked by the Router when a person accesses /newsfeed/1, /newsfeed/2, etc in browser. </span></span>
<span class="pl-s2"></span>
<span class="pl-s2"><span class="pl-s">public</span> <span class="pl-s">function</span> <span class="pl-enf">index</span>(<span class="pl-v"><span class="pl-pdv">$</span>posts</span>, <span class="pl-v"><span class="pl-pdv">$</span>poster</span>) {</span>
<span class="pl-s2">    <span class="pl-c"><span class="pl-pdc">//</span>$posts and $poster are automatically filled for us</span></span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-c"><span class="pl-pdc">//</span>Render Backend/Newsfeed view located in Views folder </span></span>
<span class="pl-s2">    <span class="pl-c"><span class="pl-pdc">//</span>Magically create an AngularJS object for $posts</span></span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-sc">View</span><span class="pl-ko">::</span>make(<span class="pl-s1"><span class="pl-pds">'</span>Backend/Newsfeed<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-pdv">$</span>posts</span>); </span>
<span class="pl-s2">}</span></pre></div>

<p><strong>View:</strong> <code>Views/Backend/Newsfeed.html</code></p>

<div class="highlight highlight-html"><pre>&lt;<span class="pl-ent">div</span> <span class="pl-eoa">class</span>=<span class="pl-s1"><span class="pl-pds">"</span>container<span class="pl-pds">"</span></span>&gt;
    Hello!

    &lt;<span class="pl-ent">ng</span><span class="pl-eoa">-form</span>&gt;Add new post: &lt;<span class="pl-ent">input</span> <span class="pl-eoa">type</span>=<span class="pl-s1"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-model</span>=<span class="pl-s1"><span class="pl-pds">"</span>newtitle<span class="pl-pds">"</span></span> /&gt;&lt;<span class="pl-ent">button</span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>createPost();<span class="pl-pds">"</span></span>&gt;Create post&lt;/<span class="pl-ent">button</span>&gt;&lt;/<span class="pl-ent">ng</span><span class="pl-eoa">-form</span>&gt;

    &lt;<span class="pl-ent">h3</span>&gt;Existing posts&lt;/<span class="pl-ent">h3</span>&gt;

    <span class="pl-c"><span class="pl-pdc">&lt;!--</span> Remember $scope.posts is now an AngularJS object! <span class="pl-pdc">--&gt;</span></span>
    &lt;<span class="pl-ent">div</span> <span class="pl-eoa">ng-repeat</span>=<span class="pl-s1"><span class="pl-pds">"</span>post in posts<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">h3</span>&gt;{{post.title}}&lt;/<span class="pl-ent">h3</span>&gt; by post.poster.first

        &lt;<span class="pl-ent">ng</span><span class="pl-eoa">-form</span>&gt;&lt;<span class="pl-ent">input</span> <span class="pl-eoa">type</span>=<span class="pl-s1"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-model</span>=<span class="pl-s1"><span class="pl-pds">"</span>post.title<span class="pl-pds">"</span></span> <span class="pl-eoa">placeholder</span>=<span class="pl-s1"><span class="pl-pds">"</span>title<span class="pl-pds">"</span></span> /&gt;
           &lt;<span class="pl-ent">button</span> <span class="pl-eoa">ng-disabled</span>=<span class="pl-s1"><span class="pl-pds">"</span>post.$dirty<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>updatePost(post);<span class="pl-pds">"</span></span>&gt;Update post&lt;/<span class="pl-ent">button</span>&gt;&lt;<span class="pl-ent">ng</span><span class="pl-eoa">-form</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

<span class="pl-s2">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s2"><span class="pl-s">function</span> <span class="pl-enf">extend</span>(<span class="pl-vpf">$scope</span>) {</span>
<span class="pl-s2">    <span class="pl-sc">$scope</span>.<span class="pl-enf">createPost</span> <span class="pl-ko">=</span> <span class="pl-s">function</span>() {</span>
<span class="pl-s2">        <span class="pl-c"><span class="pl-pdc">//</span>will create a new post and with the user's title</span></span>
<span class="pl-s2">        <span class="pl-s">var</span> post <span class="pl-ko">=</span> $scope.posts.create().set(<span class="pl-s1"><span class="pl-pds">'</span>title<span class="pl-pds">'</span></span>, $scope.newtitle).save();</span>
<span class="pl-s2">        console<span class="pl-sf">.log</span>(<span class="pl-s1"><span class="pl-pds">"</span>post: <span class="pl-pds">"</span></span>, post); <span class="pl-c"><span class="pl-pdc">//</span>will have post_id, etc</span></span>
<span class="pl-s2">    }</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-sc">$scope</span>.<span class="pl-enf">updatePost</span> <span class="pl-ko">=</span> <span class="pl-s">function</span>(<span class="pl-vpf">post</span>) {</span>
<span class="pl-s2">        post.save();</span>
<span class="pl-s2">    }</span>
<span class="pl-s2">}</span>
<span class="pl-s2">&lt;/<span class="pl-ent">script</span>&gt;</span></pre></div>

<h3>
<a id="so-are-you-with-me-so-far-" class="anchor" href="#so-are-you-with-me-so-far-" aria-hidden="true"><span class="octicon octicon-link"></span></a>So are you with me so far? :)</h3>

<p>As you can see above, the View class automatically converted our $posts Model into an AngularJS object and added it to our current <code>$scope</code> as <code>$scope.posts</code></p>

<p><code>$scope.posts</code> is an <em>array of objects</em> on which you can iterate with ng-repeat.</p>

<p><code>$scope.posts</code> is an array but it has a few functions of its own like <code>.create()</code>, <code>loadNextPage()</code>, etc. </p>

<p>Each item in <code>$scope.posts</code> array is an object of <code>Record</code> type (let's call it a <code>PostItem</code> in this case) with functions like <code>set()</code>, <code>save()</code>, etc.</p>

<p><strong>But here is the most interesting part!</strong></p>

<p>Do you remember about our <code>users[posts.user_id] as poster</code> in the router? </p>

<p>What this means to you is that we first created a <code>$posts</code> array. Then we created <code>$poster</code> object (instance of Users Model) and joined it with the users table by matching the <code>user_id</code>.</p>

<p>So what this also means to you is that each item inside <code>$scope.posts</code> there is a reference to it's <code>poster</code> object as well.</p>

<p>So <code>{{$posts[0].poster.firstName}}</code> will print the first name of the poster in AngularJS.</p>

<blockquote>
<p>Too hard to comprehend? I hope not! :) But I'll give you another example..</p>
</blockquote>

<p>Also let's add two more tables called <code>posts_likes</code> and <code>comments_likes</code>.<br>
    - <code>posts_likes</code> contains two fields called <code>user_id</code> and <code>post_id</code> to keep track of which <code>user</code> liked which <code>post</code>. 
    - <code>comments_likes</code> similary contains two fields called <code>user_id</code> and <code>comment_id</code> to keep track of which <code>user</code> liked which <code>comment</code>. </p>

<p>Ok, now take a look at this route.. you'll probably go <em>whaaaaa</em>, but the concept behind it is simple and once you get it, things will begin to look very easy! :)</p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-v"><span class="pl-pdv">$</span>r</span><span class="pl-ko">-&gt;</span>get(<span class="pl-s1"><span class="pl-pds">'</span>/newsfeed/:user_id<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>Backend/Newsfeed@index<span class="pl-pds">'</span></span>, <span class="pl-c1">false</span>,</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-s1"><span class="pl-pds">'</span>posts[user_id][2] order by post_id asc<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>users[posts.user_id] as poster<span class="pl-pds">'</span></span>,</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-s1"><span class="pl-pds">'</span>postsLikes[posts.post_id][] as plikes<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>users[plikes.user_id] as pliker<span class="pl-pds">'</span></span>,</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-s1"><span class="pl-pds">'</span>comments[posts.post_id][] order by comment_id desc<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>users[comments.user_id] as commenter<span class="pl-pds">'</span></span>,</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-s1"><span class="pl-pds">'</span>commentsLikes[comments.comment_id][] as clikes<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>users[clikes.user_id] as cliker<span class="pl-pds">'</span></span></span>
<span class="pl-s2">);</span></pre></div>

<p>Now let's pull every single parameters apart to make things clear:</p>

<ol>
<li>
<code>posts[user_id][2] order by post_id asc</code> Same as last example, only difference is

<ol>
<li>We load only the first two records only, hence the [2] instead just [] at the end. </li>
<li>To load more records we can call <code>$scope.posts.loadNextPage()</code> inside AngularJS.</li>
<li>You can also use <code>posts[user_id][1,5]</code> syntax.

<ul>
<li>Here the first digit is page number, second digit is number of results. </li>
<li>So this will load the second page (page starts at 0) with 5 results, i.e. rows: 5 ~ 10.</li>
</ul>
</li>
</ol>
</li>
<li> <code>users[posts.user_id] as poster</code> Same as last time. We want to load the poster of each post by creating a join on posts.user_id on the users table. Remember that since we don't have a trailing [] at the end, it tells MinutePHP we want the first matching object (not the whole array of matching results).</li>
<li>
<code>postsLikes[posts.post_id][] as plikes</code> Create a <code>$postsLikes</code> object by creating a join on <code>posts</code>  and <code>post_likes</code> table using <code>post_id</code>.</li>
<li>
<code>users[plikes.user_id] as pliker</code> We want to know the name of user who liked the post. So we create a <code>$pliker</code> object creating a join on <code>users</code> and <code>postsLikes</code> (alias plikes) table using <code>user_id</code>.</li>
<li>
<code>comments[posts.post_id][] order by comment_id desc</code> Since each posts can have comments inside it, we create a <code>$comments</code> object joining <code>posts</code> and <code>comments</code> using <code>post_id</code>.

<ol>
<li>Since we wish to load the comments in the reverse order in which they were posted, we add an order by clause: <code>order by comment_id desc</code> (same as SQL).</li>
</ol>
</li>
<li>
<code>users[comments.user_id] as commenter</code> We also want the name of the user who made the comment, so we create a new <code>$commenter</code> object joining the <code>comments</code> and <code>users</code> table using <code>user_id</code>.</li>
<li>
<p><code>commentsLikes[comments.comment_id][] as clikes</code> This is pretty much same as postLikes, except we're using it for commentsLikes.</p>

<p>-<em>Note:</em> that some Models end with <code>[]</code> while other don't. In case you've forgotten that is because some times we want the whole array of objects, as in case of $posts, $comments, etc. But other times we just want the first object, as in the user who made the post, or user who made the comment, etc.</p>
</li>
</ol>

<p>When we render our view all these objects will be converted to AngularJS objects. So broadly speaking our code will look something like this:</p>

<div class="highlight highlight-html"><pre>&lt;<span class="pl-ent">div</span> <span class="pl-eoa">ng-repeat</span>=<span class="pl-s1"><span class="pl-pds">"</span>post in posts<span class="pl-pds">"</span></span>&gt;
    {{post.title}} by {{post.poster.first}}

    &lt;<span class="pl-ent">div</span> <span class="pl-eoa">ng-repeat</span>=<span class="pl-s1"><span class="pl-pds">"</span>comment in post.comments<span class="pl-pds">"</span></span>&gt;
        {{comment.title}} by {{comment.commenter.first}}        
    &lt;/<span class="pl-ent">div</span>&gt;

    &lt;<span class="pl-ent">input</span> <span class="pl-eoa">type</span>=<span class="pl-s1"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-model</span>=<span class="pl-s1"><span class="pl-pds">"</span>userinput<span class="pl-pds">"</span></span> /&gt;
    &lt;<span class="pl-ent">button</span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>createItem(post.comments)<span class="pl-pds">"</span></span>&gt;Add comment&lt;/<span class="pl-ent">button</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

&lt;<span class="pl-ent">input</span> <span class="pl-eoa">type</span>=<span class="pl-s1"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-model</span>=<span class="pl-s1"><span class="pl-pds">"</span>userinput<span class="pl-pds">"</span></span> /&gt;
&lt;<span class="pl-ent">button</span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>createItem(posts)<span class="pl-pds">"</span></span>&gt;Add new post&lt;/<span class="pl-ent">button</span>&gt;

&lt;<span class="pl-ent">button</span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>posts.loadNextPage();<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-show</span>=<span class="pl-s1"><span class="pl-pds">"</span>posts.$more<span class="pl-pds">"</span></span>&gt;Next page &gt;&lt;/<span class="pl-ent">button</span>&gt;</pre></div>

<p>What it does?</p>

<ul>
<li>Show the first two posts, print their titles along with the name of the user who made the post.</li>
<li>Inside each post will be all the comments with the name of the user who made it!</li>
<li>A logged in user can add a new post to this page.</li>
<li>A logged in user can add a new comment under each post.</li>
<li>The Next page button will add two more posts.</li>
</ul>

<p>Similar to example #1, if you want the user to create a new post or comment, all you have to do is this:</p>

<div class="highlight highlight-html"><pre><span class="pl-s2">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s2"><span class="pl-s">function</span> <span class="pl-enf">extend</span>(<span class="pl-vpf">$scope</span>) {</span>
<span class="pl-s2">    <span class="pl-sc">$scope</span>.<span class="pl-enf">createItem</span> <span class="pl-ko">=</span> <span class="pl-s">function</span>(<span class="pl-vpf">item</span>) {</span>
<span class="pl-s2">        <span class="pl-c"><span class="pl-pdc">//</span>will create a new post or comment</span></span>
<span class="pl-s2">        item.create().set(<span class="pl-s1"><span class="pl-pds">'</span>title<span class="pl-pds">'</span></span>, $scope.userinput).save();</span>
<span class="pl-s2">    }</span>
<span class="pl-s2">}</span>
<span class="pl-s2">&lt;/<span class="pl-ent">script</span>&gt;</span></pre></div>

<p>Now the last part. How to add comment and post likes? Well, it's easy.</p>

<p>We already have created a <code>$plikes</code> object for each post. Let's say we want to show the number of people who like the post:</p>

<div class="highlight highlight-html"><pre>&lt;<span class="pl-ent">div</span> <span class="pl-eoa">ng-repeat</span>=<span class="pl-s1"><span class="pl-pds">"</span>post in posts<span class="pl-pds">"</span></span>&gt;
    {{post.title}} by {{post.poster.first}}

    &lt;<span class="pl-ent">span</span>&gt;{{post.plikes.count-1}} like this post!&lt;/<span class="pl-ent">span</span>&gt;
    &lt;<span class="pl-ent">ng</span><span class="pl-eoa">-switch</span> <span class="pl-eoa">on</span>=<span class="pl-s1"><span class="pl-pds">"</span>didILike(post.plikes)<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">a</span> <span class="pl-eoa">ng-show-when</span>=<span class="pl-s1"><span class="pl-pds">"</span>false<span class="pl-pds">"</span></span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>likePost(post)<span class="pl-pds">"</span></span>&gt;like this post!&lt;/<span class="pl-ent">a</span>&gt;
        &lt;<span class="pl-ent">a</span> <span class="pl-eoa">ng-show-default</span> <span class="pl-eoa">ng-click</span>=<span class="pl-s1"><span class="pl-pds">"</span>unLikePost(didILike(post.plikes))<span class="pl-pds">"</span></span>&gt;Unlike!&lt;/<span class="pl-ent">a</span>&gt;
    &lt;/<span class="pl-ent">ng</span><span class="pl-eoa">-switch</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

<span class="pl-s2">&lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s2"><span class="pl-s">function</span> <span class="pl-enf">extend</span>(<span class="pl-vpf">$scope</span>) {</span>
<span class="pl-s2">    <span class="pl-sc">$scope</span>.<span class="pl-enf">likePost</span> <span class="pl-ko">=</span> <span class="pl-s">function</span>(<span class="pl-vpf">post</span>) {</span>
<span class="pl-s2">        post.plikes.create().save();</span>
<span class="pl-s2">    }</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-sc">$scope</span>.<span class="pl-enf">unLikePost</span> <span class="pl-ko">=</span> <span class="pl-s">function</span>(<span class="pl-vpf">plike</span>) {</span>
<span class="pl-s2">        plike.<span class="pl-sf">remove</span>();</span>
<span class="pl-s2">    }</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-sc">$scope</span>.<span class="pl-enf">didILike</span> <span class="pl-ko">=</span> <span class="pl-s">function</span>(<span class="pl-vpf">arr</span>) {</span>
<span class="pl-s2">        <span class="pl-c"><span class="pl-pdc">//</span>using underscore.js, return object where user_id == 1;</span></span>
<span class="pl-s2">        <span class="pl-k">return</span> _.findWhere(arr, { user_id<span class="pl-ko">:</span> <span class="pl-cn">1</span>}) <span class="pl-ko">||</span> <span class="pl-c1">false</span>;</span>
<span class="pl-s2">    }</span>
<span class="pl-s2">}</span>
<span class="pl-s2">&lt;/<span class="pl-ent">script</span>&gt;   </span></pre></div>

<p>To quickly explain the above code:</p>

<p>When a user likes a post we simply have to add the user_id, and post_id to our <code>PostsLikes</code> table. So in our case we just call <code>plikes.create()</code> and save it.</p>

<p>The <code>didILike</code> function is basically returns the first matching object inside the <code>$scope.posts.plikes</code> array where the object has <code>user_id</code> = 1 (we assume the logged in user's user_id = 1 for this demo).</p>

<p>To unlike a post, we simply just pass this Record (or the matching item inside the <code>$scope.posts.plikes</code> array) and call the remove function on it, thus deleting the record and removing the like.</p>

<p>To keep things simple I have not covered the creation, updating and removal of objects so far. By default all models are created with the following permissions:
    - <strong>Read</strong> permission: <code>same_user</code> (i.e. the person who created the record can only read it.. or basically the user_id has to match)
    - <strong>Update</strong> permission: <code>same_user</code> (i.e. the person who created the record can only update it..)
    - <strong>Insert</strong> permission: <code>none</code> (nobody can insert anything by default)
    - <strong>Delete</strong> permission: <code>none</code> (nobody can delete anything by default)</p>

<p>So to let users insert or delete stuff we have to setup routes to make it possible. The only code you have to add here is change the Model permissions to allow this to happen.</p>

<p>So take this sample:</p>

<p><strong>File: <code>index.php</code></strong></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-c"><span class="pl-pdc">//</span>$r-&gt;get('/newsfeed/:user_id', 'Backend/Newsfeed@index', false, ...</span></span>
<span class="pl-s2">  <span class="pl-v"><span class="pl-pdv">$</span>r</span><span class="pl-ko">-&gt;</span>post(<span class="pl-s1"><span class="pl-pds">'</span>/newsfeed/:user_id/posts/update<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>Backend/Newsfeed@updatePosts<span class="pl-pds">'</span></span>, <span class="pl-c1">false</span>, <span class="pl-s1"><span class="pl-pds">'</span>posts[$data]<span class="pl-pds">'</span></span>);</span></pre></div>

<p><strong>Controller:</strong> <code>Backend/Newsfeed class</code></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-c"><span class="pl-pdc">//</span>This is the Controller class. It is invoked by the Router when a person makes a POST request to /newsfeed/1/posts/update</span></span>
<span class="pl-s2"></span>
<span class="pl-s2"><span class="pl-s">public</span> <span class="pl-s">function</span> <span class="pl-enf">updatePosts</span>(<span class="pl-v"><span class="pl-pdv">$</span>posts</span>) {</span>
<span class="pl-s2">    <span class="pl-k">if</span> (<span class="pl-v"><span class="pl-pdv">$</span>posts</span><span class="pl-ko">-&gt;</span>getAction() <span class="pl-ko">==</span> <span class="pl-s1"><span class="pl-pds">'</span>remove<span class="pl-pds">'</span></span>) {</span>
<span class="pl-s2">        <span class="pl-v"><span class="pl-pdv">$</span>posts</span><span class="pl-ko">-&gt;</span>setDeletePermission(<span class="pl-s1"><span class="pl-pds">'</span>same_user<span class="pl-pds">'</span></span>);</span>
<span class="pl-s2">        <span class="pl-v"><span class="pl-pdv">$</span>success</span> <span class="pl-ko">=</span> <span class="pl-v"><span class="pl-pdv">$</span>posts</span><span class="pl-ko">-&gt;</span>remove();</span>
<span class="pl-s2">    } <span class="pl-k">else</span> {</span>
<span class="pl-s2">        <span class="pl-v"><span class="pl-pdv">$</span>posts</span><span class="pl-ko">-&gt;</span>setUpdatePermission(<span class="pl-s1"><span class="pl-pds">'</span>same_user<span class="pl-pds">'</span></span>);</span>
<span class="pl-s2">        <span class="pl-v"><span class="pl-pdv">$</span>posts</span><span class="pl-ko">-&gt;</span>setInsertPermission(<span class="pl-s1"><span class="pl-pds">'</span>same_user<span class="pl-pds">'</span></span>);</span>
<span class="pl-s2">        <span class="pl-v"><span class="pl-pdv">$</span>success</span> <span class="pl-ko">=</span> <span class="pl-v"><span class="pl-pdv">$</span>posts</span><span class="pl-ko">-&gt;</span>save();</span>
<span class="pl-s2">    }</span>
<span class="pl-s2"></span>
<span class="pl-s2">    <span class="pl-sc">View</span><span class="pl-ko">::</span>getInstance()<span class="pl-ko">-&gt;</span>make(<span class="pl-s1"><span class="pl-pds">'</span>Backend/Newsfeed<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-pdv">$</span>success</span>);</span>
<span class="pl-s2">}</span></pre></div>

<p>The advantage of this approach is that your scripts will continue to work even if the user has disabled Javascript on her end. This is important for Signup pages, old mobile devices, etc.</p>

<h3>
<a id="generating-model-classes-and-controllers" class="anchor" href="#generating-model-classes-and-controllers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generating Model Classes and Controllers</h3>

<p>You don't have to write most of the stuff by hand. The <em>minute.php</em> <code>CLI</code> script will create both Models and Controllers Classes for you.</p>

<p><strong>Examples:</strong></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-c"><span class="pl-pdc">#</span>To create Model Classes (only support MySQL currently)</span></span>
<span class="pl-s2">$<span class="pl-ko">&gt;</span> <span class="pl-c1">php</span> <span class="pl-c1">Minute</span><span class="pl-ko">/</span><span class="pl-c1">CLI</span><span class="pl-ko">/</span><span class="pl-c1">minute</span><span class="pl-ko">.</span><span class="pl-c1">php</span> <span class="pl-ko">--</span><span class="pl-c1">create</span><span class="pl-ko">-</span><span class="pl-c1">models</span> <span class="pl-ko">--</span><span class="pl-c1">db</span><span class="pl-ko">=</span><span class="pl-c1">fb</span> <span class="pl-ko">--</span><span class="pl-c1">host</span><span class="pl-ko">=</span><span class="pl-c1">localhost</span> <span class="pl-ko">--</span><span class="pl-c1">user</span><span class="pl-ko">=</span><span class="pl-c1">root</span></span>
<span class="pl-s2"></span>
<span class="pl-s2"><span class="pl-c"><span class="pl-pdc">#</span>To generate Controller classes (file must be inside `public` directory)</span></span>
<span class="pl-s2">$<span class="pl-ko">&gt;</span> <span class="pl-c1">php</span> <span class="pl-c1">Minute</span><span class="pl-ko">/</span><span class="pl-c1">CLI</span><span class="pl-ko">/</span><span class="pl-c1">minute</span><span class="pl-ko">.</span><span class="pl-c1">php</span> <span class="pl-ko">--</span><span class="pl-c1">create</span><span class="pl-ko">-</span><span class="pl-c1">controllers</span> <span class="pl-ko">--</span><span class="pl-c1">file</span><span class="pl-ko">=</span><span class="pl-c1">index</span><span class="pl-ko">.</span><span class="pl-c1">php</span></span></pre></div>

<h3>
<a id="so-whats-next" class="anchor" href="#so-whats-next" aria-hidden="true"><span class="octicon octicon-link"></span></a>So what's next?</h3>

<ol>
<li>
<p><strong>Controller chaining:</strong> You may ask.. what's that? It's basically a way to create an array of controllers and chain them together like this:</p>

<p><strong>File: <code>index.php</code></strong></p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-v"><span class="pl-pdv">$</span>r</span><span class="pl-ko">-&gt;</span>get(<span class="pl-s1"><span class="pl-pds">'</span>/billing/paypal<span class="pl-pds">'</span></span>, [<span class="pl-s1"><span class="pl-pds">'</span>Plugins/Paypal@IPN as ipn<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>Billing@process<span class="pl-pds">'</span></span>], <span class="pl-c1">false</span>, <span class="pl-ko">...</span>)</span>
<span class="pl-s2"><span class="pl-v"><span class="pl-pdv">$</span>r</span><span class="pl-ko">-&gt;</span>get(<span class="pl-s1"><span class="pl-pds">'</span>/billing/2co<span class="pl-pds">'</span></span>,    [<span class="pl-s1"><span class="pl-pds">'</span>Plugins/TwoCO@IPN as ipn<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>Billing@process<span class="pl-pds">'</span></span>], <span class="pl-c1">false</span>, <span class="pl-ko">...</span>)</span></pre></div>

<p>There are a bunch of task that you have to do in every site, so I am thinking that we can write a few plugins, and then chain these to our controllers using an array. So that when the <code>process</code> function is invoked in the <code>Billing</code> class it is automatically injected with a <code>$ipn</code> object that has already processed the payment and contains a simple <code>$payment</code> object like <code>{pass: true, amount:33.33}</code></p>
</li>
<li><p><strong>HybridAuth integration:</strong> I think hybriadauth is the best solution for implementing login and signup. So I will probably use that and create an OAuth provider inside MinutePHP to provide the option to signup by email.</p></li>
<li>
<p><strong>An <code>$scope.posts.on('item_added', ...)</code> handler:</strong> Right now the only way to check for changes is via the <code>.$dirty</code> flag on Records [it automatically resets after <code>.save()</code>]. </p>

<p>But instead I want to add a Global <code>.on</code> handler that fires events even when the <code>$scope.posts</code> is changed by <em>anybody</em>. This can be easily implement using Websockets. </p>

<p>So take for example, our facebook feed demo, if there was a to hook <code>$scope.posts.on('item_added', ..)</code> we can easily create a notification for the user that a new post was created, or somebody liked their post, comment, etc.</p>
</li>
</ol>

<h3>
<a id="what-else" class="anchor" href="#what-else" aria-hidden="true"><span class="octicon octicon-link"></span></a>What else?</h3>

<p>It's just something I'm doing in my spare time. It is by no means perfect or production ready but the sample code works great so far it is working exactly as I expected. </p>

<p>Sorry for not taking a TDD approach. I was having way too much fun with the Router and Models that I kinda skipped that :P But the PHPUnit tests are coming very soon :) Of course some help with that would be greatly appreciated always.</p>

<p>By the way, I've tried the facebook feed demo with about 100,000 records and the system seems to run like a breeze. The total lines of code is about 50 which consists of mostly HTML (or AngularJS).</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Minutephp maintained by <a href="https://github.com/superasn">superasn</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
